extends layout

block content
  div(class="container mx-auto px-4 py-6")
    div(class="grid grid-cols-1 lg:grid-cols-3 gap-8")
      // Left Column: Player and Details
      div(class="lg:col-span-2")
        // Player
        div(class="relative bg-black rounded-xl overflow-hidden shadow-2xl mb-4 aspect-video")
          div(id="playerLoading" class="absolute inset-0 bg-black bg-opacity-75 flex items-center justify-center z-20")
            div(class="text-center text-white")
              div(class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary-500 mx-auto mb-4")
              p Memuat Video...
          if episode.quality
            video(id="player" playsinline crossorigin)
              if episode.video_sources && Array.isArray(episode.video_sources)
                each source in episode.video_sources
                  source(src=source.url || source type=source.type || "video/mp4")
              else if episode.qlist
                each source in episode.qlist
                  source(src=episode.quality[source] type="video/mp4" size=source)
          else
            div(class="w-full h-full flex items-center justify-center bg-black text-white")
              p Tidak ada sumber video yang tersedia.

        // Title and Actions
          div(class="flex flex-col md:flex-row md:items-center md:justify-between mb-4")
            h1(class="text-xl md:text-2xl font-bold text-gray-900 dark:text-gray-100 mb-2 md:mb-0") #{anime.title} - #{anime.release_day || 'Unknown Date'} â€¢ Episode #{episode.number}

          div(class="flex flex-col sm:flex-row sm:items-center justify-between mb-4")
            // Channel Info
            div(class="flex items-center mb-4 sm:mb-0")
              img(src=anime.poster, alt=anime.title, class="w-12 h-12 rounded-full mr-3 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/48x48?text=A';")
              div
                p(class="font-semibold text-gray-800 dark:text-gray-200")= anime.title
                p(class="text-sm text-gray-500 dark:text-gray-400") 123K Subscribers
            
            // Subscribe Button & Actions
            div(class="flex items-center space-x-2")
              button(class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-yt-light-text dark:text-yt-dark-text font-semibold px-4 py-2 rounded-full text-sm") Subscribe
              
              div(class="flex items-center space-x-2 bg-gray-200 dark:bg-gray-700 rounded-full")
                button(class="flex items-center px-4 py-2 rounded-l-full text-sm font-medium hover:bg-gray-300 dark:hover:bg-gray-600")
                  i(data-lucide="thumbs-up" class="w-5 h-5 mr-2")
                  span 1.2K
                div(class="w-px h-6 bg-gray-300 dark:bg-gray-600")
                button(class="flex items-center px-4 py-2 rounded-r-full text-sm font-medium hover:bg-gray-300 dark:hover:bg-gray-600")
                  i(data-lucide="thumbs-down" class="w-5 h-5")
              
              button(class="flex items-center bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 px-4 py-2 rounded-full text-sm font-medium")
                i(data-lucide="share-2" class="w-5 h-5 mr-2")
                span Bagikan
              if episode.download_links
                button(onclick="toggleDownloads()" class="flex items-center bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 px-4 py-2 rounded-full text-sm font-medium")
                  i(data-lucide="download" class="w-5 h-5 mr-2")
                  span Unduh


        // Description Box
        div(class="bg-gray-100 dark:bg-gray-800 rounded-xl p-4 text-sm")
          p(class="font-semibold") #{anime.rating || 'N/A'}
          p(class="text-gray-700 dark:text-gray-300 mt-2 line-clamp-3")= anime.synopsis
      
      // Right Column: Episode List
      div(class="lg:col-span-1")
        h2(class="text-lg font-bold mb-4") Daftar Episode
        div(class="flex flex-col space-y-2 max-h-[80vh] overflow-y-auto pr-2")
          if navigation && navigation.all_episodes
            each ep in navigation.all_episodes
              a(href=`/anime/${anime.slug}/episode/${ep.slug}` class=`group flex items-center space-x-3 p-2 rounded-lg transition-colors ${ep.number == episode.number ? 'bg-primary-100 dark:bg-primary-900' : 'hover:bg-gray-100 dark:hover:bg-gray-800'}`)
                div(class="w-1/3")
                  img(src=anime.poster, alt=`Episode ${ep.number}` class="w-full h-auto object-cover rounded aspect-video bg-gray-300 dark:bg-gray-700" onerror="this.onerror=null;this.src='https://placehold.co/160x90?text=IMG';")
                div(class="w-2/3")
                  h3(class=`text-sm font-semibold line-clamp-2 ${ep.number == episode.number ? 'text-primary-700 dark:text-primary-300' : 'text-gray-800 dark:text-gray-200'}`)= `Episode ${ep.number}`
                  p(class="text-xs text-gray-500 dark:text-gray-400")= anime.title

// Download Modal (Hidden by default, or could be a section)
div(id="downloadContent" class="hidden fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4")
  // ... (Your existing download content can be moved and styled into a modal)

block scripts
  script.
    // Simplified Plyr Initialization
    const player = new Plyr('#player', {
      controls: ['play-large', 'play', 'progress', 'current-time', 'mute', 'volume', 'settings', 'fullscreen'],
      settings: ['quality', 'speed'],
    });

    const loadingOverlay = document.getElementById('playerLoading');
    const episodeSlug = '#{episode.slug}'; // Get episodeSlug from Pug variable
    const lastViewedTimestamp = parseFloat('#{lastViewedTimestamp}'); // Get timestamp from Pug variable

    let saveProgressInterval;

    // Function to save watch progress to backend
    async function saveWatchProgress(currentTime) {
      if (!episodeSlug || !#{user}) return; // Only save for logged-in users

      try {
        await fetch('/api/user/history', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ episodeSlug, timestamp: currentTime }),
        });
        // console.log('Progress saved:', currentTime);
      } catch (error) {
        console.error('Failed to save watch progress:', error);
      }
    }

    // Load progress when metadata is loaded
    player.on('loadedmetadata', () => {
      if (lastViewedTimestamp > 5 && lastViewedTimestamp < player.duration * 0.95) {
        player.currentTime = lastViewedTimestamp;
        // console.log('Resuming from:', lastViewedTimestamp);
      }
    });

    player.on('play', () => {
      // Start periodically saving progress
      if (!saveProgressInterval && #{user}) { // Only start if logged in
        saveProgressInterval = setInterval(() => {
          saveWatchProgress(player.currentTime);
        }, 15000); // Save every 15 seconds
      }
    });

    player.on('pause', () => {
      // Save progress immediately on pause
      clearInterval(saveProgressInterval);
      saveProgressInterval = null;
      if (#{user}) {
        saveWatchProgress(player.currentTime);
      }
    });

    player.on('ended', () => {
      // Save 0 or duration on end to mark as complete or reset
      clearInterval(saveProgressInterval);
      saveProgressInterval = null;
      if (#{user}) {
        saveWatchProgress(0); // Or player.duration if you want to mark as fully watched
      }
      // Continue with next episode logic if applicable
      // ... existing next episode logic
    });
    
    // Save progress before user leaves the page
    window.addEventListener('beforeunload', () => {
      if (player.playing && #{user}) {
        saveWatchProgress(player.currentTime);
      }
      clearInterval(saveProgressInterval);
    });

    // Handle player loading states
    player.on('loadstart', () => { loadingOverlay.style.display = 'flex'; });
    player.on('canplay', () => { loadingOverlay.style.display = 'none'; });
    player.on('error', () => { 
      loadingOverlay.innerHTML = '<p>Error memuat video.</p>';
      loadingOverlay.style.display = 'flex';
    });

    function toggleDownloads() {
      // Basic modal toggle logic - can be improved
      const modal = document.getElementById('downloadContent');
      if (modal) {
        modal.classList.toggle('hidden');
      }
    }
