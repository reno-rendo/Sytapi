extends layout

block content
  div(class="bg-gray-50 dark:bg-gray-900")
    // Banner
    div(class="h-48 md:h-64 bg-cover bg-center" style=`background-image: url(${anime.poster})`)
      div(class="h-full w-full bg-black/50 backdrop-blur-sm")

    div(class="container mx-auto px-4 -mt-16")
      // Channel Header
      div(class="flex flex-col md:flex-row items-center md:items-end p-4")
        div(class="flex-shrink-0")
          img(src=anime.poster alt=anime.title class="w-32 h-32 md:w-48 md:h-48 object-cover rounded-lg shadow-lg border-4 border-gray-50 dark:border-gray-800" onerror="this.onerror=null;this.src='https://placehold.co/200x200?text=No+Image';")
        div(class="md:ml-6 mt-4 md:mt-0 text-center md:text-left")
          h1(class="text-2xl md:text-4xl font-bold text-gray-900 dark:text-gray-100")= anime.title
          div(class="flex items-center justify-center md:justify-start space-x-4 mt-2 text-sm text-gray-600 dark:text-gray-400")
            if anime.rating
              span Rating: #{anime.rating}
            if anime.status
              span ▪ #{anime.status}
            if anime.release_year
              span ▪ #{anime.release_year}
          p(class="mt-2 text-sm text-gray-700 dark:text-gray-300 max-w-2xl line-clamp-2")= anime.synopsis
        div(class="flex-grow")
        div(class="mt-4 md:mt-0 flex items-center space-x-3")
          if user
            button(id="bookmarkBtn" onclick=`toggleBookmark('${anime.slug}')` class=`flex items-center space-x-2 px-4 py-2 rounded-full text-sm font-semibold transition-colors duration-200 ${isBookmarked ? 'bg-yt-red text-white' : 'bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600'}`)
              i(data-lucide="bookmark" class=`w-4 h-4 ${isBookmarked ? 'fill-white' : ''}`)
              span Bookmark
            button(id="likeBtn" onclick=`toggleLike('${anime.slug}')` class=`flex items-center space-x-2 px-4 py-2 rounded-full text-sm font-semibold transition-colors duration-200 ${isLiked ? 'bg-yt-red text-white' : 'bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600'}`)
              i(data-lucide="heart" class=`w-4 h-4 ${isLiked ? 'fill-white' : ''}`)
              span Like
          button(class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-yt-light-text dark:text-yt-dark-text font-semibold px-5 py-2 rounded-full") Subscribe

      // Tabs (Placeholder for now, content is the episode list)
      div(class="mt-6 border-b border-gray-200 dark:border-gray-700")
        nav(class="flex space-x-4")
          button(class="py-3 px-1 border-b-2 border-red-600 text-gray-800 dark:text-white font-semibold") EPISODE
          //- other tabs like 'ABOUT' can be added here

      // Episode List
      div(class="mt-6")
        if anime.episodes && anime.episodes.length > 0
          div(class="flex flex-col")
            div(class="-my-2 overflow-x-auto")
              div(class="py-2 align-middle inline-block min-w-full")
                div(class="shadow overflow-hidden border-b border-gray-200 dark:border-gray-700 sm:rounded-lg")
                  table(class="min-w-full divide-y divide-gray-200 dark:divide-gray-700")
                    tbody(class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700")
                      each episode in anime.episodes
                        tr(class="hover:bg-gray-50 dark:hover:bg-gray-700")
                          td(class="px-6 py-4 whitespace-nowrap")
                            a(href=`/anime/${anime.slug}/episode/${episode.episode}` class="flex items-center")
                              div(class="flex-shrink-0 h-10 w-10")
                                p(class="text-lg font-bold text-gray-500 dark:text-gray-400") #{episode.episode}
                              div(class="ml-4")
                                div(class="text-sm font-medium text-gray-900 dark:text-gray-100")= `Episode ${episode.episode}`
                                if episode.release_date
                                  div(class="text-sm text-gray-500 dark:text-gray-400")= episode.release_date
        else
          div(class="text-center py-12")
            p(class="text-lg text-gray-500") Tidak ada episode yang tersedia untuk anime ini.

block scripts
  script.
    async function toggleStatus(type, animeSlug, buttonId) {
      const button = document.getElementById(buttonId);
      if (!button) return;

      try {
        const response = await fetch(`/api/user/${type}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ animeSlug }),
        });
        const data = await response.json();

        if (data.success) {
          const icon = button.querySelector('i[data-lucide]');
          if (data.action === 'added') {
            button.classList.add('bg-yt-red', 'text-white');
            button.classList.remove('bg-gray-200', 'dark:bg-gray-700', 'hover:bg-gray-300', 'dark:hover:bg-gray-600');
            if (icon) icon.classList.add('fill-white');
          } else {
            button.classList.remove('bg-yt-red', 'text-white');
            button.classList.add('bg-gray-200', 'dark:bg-gray-700', 'hover:bg-gray-300', 'dark:hover:bg-gray-600');
            if (icon) icon.classList.remove('fill-white');
          }
          // Re-render lucide icons if their appearance changed
          if (typeof lucide !== 'undefined') {
            lucide.createIcons();
          }
        } else {
          console.error(`Failed to toggle ${type}:`, data.message);
          alert(`Gagal ${data.action === 'added' ? 'menambahkan' : 'menghapus'} ${type}: ${data.message}`);
        }
      } catch (error) {
        console.error(`Error toggling ${type}:`, error);
        alert('Terjadi kesalahan. Silakan coba lagi.');
      }
    }

    function toggleBookmark(animeSlug) {
      toggleStatus('bookmark', animeSlug, 'bookmarkBtn');
    }

    function toggleLike(animeSlug) {
      toggleStatus('like', animeSlug, 'likeBtn');
    }